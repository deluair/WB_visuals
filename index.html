<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Bank Data Visualizer</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Bootstrap CSS for better styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }
        
        .header {
            background: linear-gradient(135deg, #0056b3, #007bff);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 300;
        }
        
        .header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .control-panel {
            background: white;
            padding: 20px;
            margin: 20px auto;
            max-width: 1200px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        
        .map-container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        #map {
            height: 600px;
            width: 100%;
        }
        
        .form-select, .btn {
            margin: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .stats-panel {
            background: white;
            padding: 20px;
            margin: 20px auto;
            max-width: 1200px;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }
        
        .legend-color {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border: 1px solid #ccc;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }
        
        .info-message {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #bee5eb;
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .control-panel {
                margin: 10px;
                padding: 15px;
            }
            
            .map-container {
                margin: 10px;
            }
            
            #map {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üåç World Bank Data Visualizer</h1>
        <p>Interactive Mapping of Global Development Indicators</p>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="row">
            <div class="col-md-3">
                <label for="regionSelect" class="form-label">Select Region:</label>
                <select id="regionSelect" class="form-select">
                    <option value="all">üåç World (All Countries)</option>
                    <option value="AFR">üåç Africa</option>
                    <option value="EAS">üåè East Asia & Pacific</option>
                    <option value="ECS">üåç Europe & Central Asia</option>
                    <option value="LCN">üåé Latin America & Caribbean</option>
                    <option value="MEA">üåç Middle East & North Africa</option>
                    <option value="NAC">üåé North America</option>
                    <option value="SAS">üåè South Asia</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="countrySelect" class="form-label">Select Specific Country:</label>
                <select id="countrySelect" class="form-select">
                    <option value="">üåê All Countries in Region</option>
                    <!-- Countries will be populated dynamically -->
                </select>
            </div>
            
            <div class="col-md-4">
                <label for="indicatorSelect" class="form-label">Select Indicator:</label>
                <select id="indicatorSelect" class="form-select">
                    <option value="SP.POP.TOTL">üìä Population, Total</option>
                    <option value="NY.GDP.MKTP.CD">üí∞ GDP (Current US$)</option>
                    <option value="NY.GDP.PCAP.CD">üíµ GDP Per Capita (Current US$)</option>
                    <option value="SP.DYN.LE00.IN">üè• Life Expectancy at Birth</option>
                    <option value="SE.ADT.LITR.ZS">üìö Literacy Rate, Adult Total (%)</option>
                    <option value="SH.DYN.MORT">üë∂ Mortality Rate, Under-5 (per 1,000)</option>
                    <option value="EN.ATM.CO2E.PC">üå± CO2 Emissions (metric tons per capita)</option>
                    <option value="EG.USE.ELEC.KH.PC">‚ö° Electric Power Consumption (kWh per capita)</option>
                    <option value="IT.NET.USER.ZS">üíª Internet Users (% of population)</option>
                    <option value="SL.UEM.TOTL.ZS">üíº Unemployment, Total (% of labor force)</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="yearSelect" class="form-label">Select Year:</label>
                <select id="yearSelect" class="form-select">
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                </select>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-3">
                <label for="colorScheme" class="form-label">Color Scheme:</label>
                <select id="colorScheme" class="form-select">
                    <option value="blues">üîµ Blues</option>
                    <option value="reds">üî¥ Reds</option>
                    <option value="greens">üü¢ Greens</option>
                    <option value="purples">üü£ Purples</option>
                    <option value="oranges">üü† Oranges</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="classificationMethod" class="form-label">Classification Method:</label>
                <select id="classificationMethod" class="form-select">
                    <option value="quantile">üìä Quantile (Equal Count)</option>
                    <option value="equal">üìè Equal Interval</option>
                    <option value="natural">üéØ Natural Breaks</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label for="markerSize" class="form-label">Marker Size:</label>
                <select id="markerSize" class="form-select">
                    <option value="small">üî∏ Small</option>
                    <option value="medium" selected>üîπ Medium</option>
                    <option value="large">üî∂ Large</option>
                    <option value="extra-large">üî∑ Extra Large</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button id="loadDataBtn" class="btn btn-primary w-100">üöÄ Load Data</button>
            </div>
        </div>
        
        <div class="row mt-2">
            <div class="col-md-12">
                <div class="btn-group w-100" role="group">
                    <button id="fitToDataBtn" class="btn btn-outline-secondary">üéØ Fit to Data</button>
                    <button id="resetZoomBtn" class="btn btn-outline-secondary">üåç Reset Zoom</button>
                    <button id="toggleLabelsBtn" class="btn btn-outline-secondary">üè∑Ô∏è Toggle Labels</button>
                    <button id="exportDataBtn" class="btn btn-outline-success">üìÅ Export Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="map-container">
        <div id="map"></div>
    </div>

    <!-- Statistics Panel -->
    <div class="stats-panel" id="statsPanel" style="display: none;">
        <h4>üìä Data Statistics</h4>
        <div class="row" id="statsContent">
            <!-- Statistics will be populated here -->
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Loading World Bank data...</p>
    </div>

    <!-- Messages -->
    <div id="messageContainer" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
        <!-- Messages will appear here -->
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        class WorldBankVisualizer {
            constructor() {
                this.map = null;
                this.currentLayer = null;
                this.legend = null;
                this.currentData = null;
                this.countryCoordinates = {};
                this.countryNames = {};
                this.allCountries = [];
                this.showLabels = false;
                this.markerSizes = {
                    'small': { min: 3, max: 8 },
                    'medium': { min: 5, max: 15 },
                    'large': { min: 8, max: 25 },
                    'extra-large': { min: 12, max: 35 }
                };
                
                // Color schemes
                this.colorSchemes = {
                    blues: ['#f7fbff', '#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#084594'],
                    reds: ['#fff5f0', '#fee0d2', '#fcbba1', '#fc9272', '#fb6a4a', '#ef3b2c', '#cb181d', '#99000d'],
                    greens: ['#f7fcf5', '#e5f5e0', '#c7e9c0', '#a1d99b', '#74c476', '#41ab5d', '#238b45', '#005a32'],
                    purples: ['#fcfbfd', '#efedf5', '#dadaeb', '#bcbddc', '#9e9ac8', '#807dba', '#6a51a3', '#4a1486'],
                    oranges: ['#fff5eb', '#fee6ce', '#fdd0a2', '#fdae6b', '#fd8d3c', '#f16913', '#d94801', '#8c2d04']
                };
                
                this.initializeMap();
                this.setupEventListeners();
                this.loadCountryCoordinates();
                this.loadAllCountries();
            }

            initializeMap() {
                // Initialize the map
                this.map = L.map('map').setView([20, 0], 2);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors | Data: World Bank'
                }).addTo(this.map);
            }

            setupEventListeners() {
                document.getElementById('loadDataBtn').addEventListener('click', () => {
                    this.loadAndVisualizeData();
                });
                
                // Auto-load data when selections change
                document.getElementById('regionSelect').addEventListener('change', () => {
                    this.updateCountryDropdown();
                    if (this.currentData) this.loadAndVisualizeData();
                });
                
                document.getElementById('countrySelect').addEventListener('change', () => {
                    if (this.currentData) this.loadAndVisualizeData();
                });
                
                document.getElementById('colorScheme').addEventListener('change', () => {
                    if (this.currentData) this.updateVisualization();
                });
                
                document.getElementById('classificationMethod').addEventListener('change', () => {
                    if (this.currentData) this.updateVisualization();
                });
                
                document.getElementById('markerSize').addEventListener('change', () => {
                    if (this.currentData) this.updateVisualization();
                });
                
                // New control buttons
                document.getElementById('fitToDataBtn').addEventListener('click', () => {
                    this.fitMapToData();
                });
                
                document.getElementById('resetZoomBtn').addEventListener('click', () => {
                    this.map.setView([20, 0], 2);
                });
                
                document.getElementById('toggleLabelsBtn').addEventListener('click', () => {
                    this.showLabels = !this.showLabels;
                    if (this.currentData) this.updateVisualization();
                });
                
                document.getElementById('exportDataBtn').addEventListener('click', () => {
                    this.exportData();
                });
            }

            loadCountryCoordinates() {
                // Enhanced country coordinates and names for visualization
                this.countryCoordinates = {
                    'AFG': [33.9391, 67.7100], 'ALB': [41.1533, 20.1683], 'DZA': [28.0339, 1.6596],
                    'AGO': [-11.2027, 17.8739], 'ARG': [-38.4161, -63.6167], 'ARM': [40.0691, 45.0382],
                    'AUS': [-25.2744, 133.7751], 'AUT': [47.5162, 14.5501], 'AZE': [40.1431, 47.5769],
                    'BHR': [25.9304, 50.6378], 'BGD': [23.6850, 90.3563], 'BLR': [53.7098, 27.9534],
                    'BEL': [50.5039, 4.4699], 'BLZ': [17.1899, -88.4976], 'BEN': [9.3077, 2.3158],
                    'BTN': [27.5142, 90.4336], 'BOL': [-16.2902, -63.5887], 'BIH': [43.9159, 17.6791],
                    'BWA': [-22.3285, 24.6849], 'BRA': [-14.2350, -51.9253], 'BGR': [42.7339, 25.4858],
                    'BFA': [12.2383, -1.5616], 'BDI': [-3.3731, 29.9189], 'KHM': [12.5657, 104.9910],
                    'CMR': [7.3697, 12.3547], 'CAN': [56.1304, -106.3468], 'CPV': [16.5388, -24.0132],
                    'CAF': [6.6111, 20.9394], 'TCD': [15.4542, 18.7322], 'CHL': [-35.6751, -71.5430],
                    'CHN': [35.8617, 104.1954], 'COL': [4.5709, -74.2973], 'COM': [-11.6455, 43.3333],
                    'COG': [-0.2280, 15.8277], 'COD': [-4.0383, 21.7587], 'CRI': [9.7489, -83.7534],
                    'CIV': [7.5400, -5.5471], 'HRV': [45.1000, 15.2000], 'CUB': [21.5218, -77.7812],
                    'CYP': [35.1264, 33.4299], 'CZE': [49.8175, 15.4730], 'DNK': [56.2639, 9.5018],
                    'DJI': [11.8251, 42.5903], 'DOM': [18.7357, -70.1627], 'ECU': [-1.8312, -78.1834],
                    'EGY': [26.0975, 30.0444], 'SLV': [13.7942, -88.8965], 'GNQ': [1.6508, 10.2679],
                    'ERI': [15.1794, 39.7823], 'EST': [58.5953, 25.0136], 'ETH': [9.1450, 40.4897],
                    'FJI': [-16.7784, 179.4144], 'FIN': [61.9241, 25.7482], 'FRA': [46.6034, 1.8883],
                    'GAB': [-0.8037, 11.6094], 'GMB': [13.4432, -15.3101], 'GEO': [42.3154, 43.3569],
                    'DEU': [51.1657, 10.4515], 'GHA': [7.9465, -1.0232], 'GRC': [39.0742, 21.8243],
                    'GTM': [15.7835, -90.2308], 'GIN': [9.9456, -9.6966], 'GNB': [11.8037, -15.1804],
                    'GUY': [4.8604, -58.9302], 'HTI': [18.9712, -72.2852], 'HND': [15.2000, -86.2419],
                    'HUN': [47.1625, 19.5033], 'ISL': [64.9631, -19.0208], 'IND': [20.5937, 78.9629],
                    'IDN': [-0.7893, 113.9213], 'IRN': [32.4279, 53.6880], 'IRQ': [33.2232, 43.6793],
                    'IRL': [53.4129, -8.2439], 'ISR': [31.0461, 34.8516], 'ITA': [41.8719, 12.5674],
                    'JAM': [18.1096, -77.2975], 'JPN': [36.2048, 138.2529], 'JOR': [30.5852, 36.2384],
                    'KAZ': [48.0196, 66.9237], 'KEN': [-0.0236, 37.9062], 'KIR': [-3.3704, -168.7340],
                    'PRK': [40.3399, 127.5101], 'KOR': [35.9078, 127.7669], 'KWT': [29.3117, 47.4818],
                    'KGZ': [41.2044, 74.7661], 'LAO': [19.8563, 102.4955], 'LVA': [56.8796, 24.6032],
                    'LBN': [33.8547, 35.8623], 'LSO': [-29.6100, 28.2336], 'LBR': [6.4281, -9.4295],
                    'LBY': [26.3351, 17.2283], 'LTU': [55.1694, 23.8813], 'LUX': [49.8153, 6.1296],
                    'MKD': [41.6086, 21.7453], 'MDG': [-18.7669, 46.8691], 'MWI': [-13.2543, 34.3015],
                    'MYS': [4.2105, 101.9758], 'MDV': [3.2028, 73.2207], 'MLI': [17.5707, -3.9962],
                    'MLT': [35.9375, 14.3754], 'MHL': [7.1315, 171.1845], 'MRT': [21.0079, -10.9408],
                    'MUS': [-20.3484, 57.5522], 'MEX': [23.6345, -102.5528], 'FSM': [7.4256, 150.5508],
                    'MDA': [47.4116, 28.3699], 'MNG': [46.8625, 103.8467], 'MNE': [42.7087, 19.3744],
                    'MAR': [31.7917, -7.0926], 'MOZ': [-18.6657, 35.5296], 'MMR': [21.9162, 95.9560],
                    'NAM': [-22.9576, 18.4904], 'NRU': [-0.5228, 166.9315], 'NPL': [28.3949, 84.1240],
                    'NLD': [52.1326, 5.2913], 'NZL': [-40.9006, 174.8860], 'NIC': [12.2658, -85.2072],
                    'NER': [17.6078, 8.0817], 'NGA': [9.0820, 8.6753], 'NOR': [60.4720, 8.4689],
                    'OMN': [21.5126, 55.9233], 'PAK': [30.3753, 69.3451], 'PLW': [7.5150, 134.5825],
                    'PAN': [8.5380, -80.7821], 'PNG': [-6.3140, 143.9555], 'PRY': [-23.4425, -58.4438],
                    'PER': [-9.1900, -75.0152], 'PHL': [12.8797, 121.7740], 'POL': [51.9194, 19.1451],
                    'PRT': [39.3999, -8.2245], 'QAT': [25.3548, 51.1839], 'ROU': [45.9432, 24.9668],
                    'RUS': [61.5240, 105.3188], 'RWA': [-1.9403, 29.8739], 'WSM': [-13.7590, -172.1046],
                    'STP': [0.1864, 6.6131], 'SAU': [23.8859, 45.0792], 'SEN': [14.4974, -14.4524],
                    'SRB': [44.0165, 21.0059], 'SYC': [-4.6796, 55.4920], 'SLE': [8.4606, -11.7799],
                    'SGP': [1.3521, 103.8198], 'SVK': [48.6690, 19.6990], 'SVN': [46.1512, 14.9955],
                    'SLB': [-9.6457, 160.1562], 'SOM': [5.1521, 46.1996], 'ZAF': [-30.5595, 22.9375],
                    'SSD': [6.8770, 31.3070], 'ESP': [40.4637, -3.7492], 'LKA': [7.8731, 80.7718],
                    'SDN': [12.8628, 30.2176], 'SUR': [3.9193, -56.0278], 'SWZ': [-26.5225, 31.4659],
                    'SWE': [60.1282, 18.6435], 'CHE': [46.8182, 8.2275], 'SYR': [34.8021, 38.9968],
                    'TJK': [38.8610, 71.2761], 'TZA': [-6.3690, 34.8888], 'THA': [15.8700, 100.9925],
                    'TLS': [-8.8742, 125.7275], 'TGO': [8.6195, 0.8248], 'TON': [-21.1789, -175.1982],
                    'TTO': [10.6918, -61.2225], 'TUN': [33.8869, 9.5375], 'TUR': [38.9637, 35.2433],
                    'TKM': [38.9697, 59.5563], 'TUV': [-7.1095, 177.6493], 'UGA': [1.3733, 32.2903],
                    'UKR': [48.3794, 31.1656], 'ARE': [23.4241, 53.8478], 'GBR': [55.3781, -3.4360],
                    'USA': [37.0902, -95.7129], 'URY': [-32.5228, -55.7658], 'UZB': [41.3775, 64.5853],
                    'VUT': [-15.3767, 166.9592], 'VEN': [6.4238, -66.5897], 'VNM': [14.0583, 108.2772],
                    'YEM': [15.5527, 48.5164], 'ZMB': [-13.1339, 27.8493], 'ZWE': [-19.0154, 29.1549]
                };

                // Country names mapping
                this.countryNames = {
                    'AFG': 'Afghanistan', 'ALB': 'Albania', 'DZA': 'Algeria', 'AGO': 'Angola',
                    'ARG': 'Argentina', 'ARM': 'Armenia', 'AUS': 'Australia', 'AUT': 'Austria',
                    'AZE': 'Azerbaijan', 'BHR': 'Bahrain', 'BGD': 'Bangladesh', 'BLR': 'Belarus',
                    'BEL': 'Belgium', 'BLZ': 'Belize', 'BEN': 'Benin', 'BTN': 'Bhutan',
                    'BOL': 'Bolivia', 'BIH': 'Bosnia and Herzegovina', 'BWA': 'Botswana', 'BRA': 'Brazil',
                    'BGR': 'Bulgaria', 'BFA': 'Burkina Faso', 'BDI': 'Burundi', 'KHM': 'Cambodia',
                    'CMR': 'Cameroon', 'CAN': 'Canada', 'CPV': 'Cabo Verde', 'CAF': 'Central African Republic',
                    'TCD': 'Chad', 'CHL': 'Chile', 'CHN': 'China', 'COL': 'Colombia',
                    'COM': 'Comoros', 'COG': 'Congo, Rep.', 'COD': 'Congo, Dem. Rep.', 'CRI': 'Costa Rica',
                    'CIV': "Cote d'Ivoire", 'HRV': 'Croatia', 'CUB': 'Cuba', 'CYP': 'Cyprus',
                    'CZE': 'Czech Republic', 'DNK': 'Denmark', 'DJI': 'Djibouti', 'DOM': 'Dominican Republic',
                    'ECU': 'Ecuador', 'EGY': 'Egypt, Arab Rep.', 'SLV': 'El Salvador', 'GNQ': 'Equatorial Guinea',
                    'ERI': 'Eritrea', 'EST': 'Estonia', 'ETH': 'Ethiopia', 'FJI': 'Fiji',
                    'FIN': 'Finland', 'FRA': 'France', 'GAB': 'Gabon', 'GMB': 'Gambia, The',
                    'GEO': 'Georgia', 'DEU': 'Germany', 'GHA': 'Ghana', 'GRC': 'Greece',
                    'GTM': 'Guatemala', 'GIN': 'Guinea', 'GNB': 'Guinea-Bissau', 'GUY': 'Guyana',
                    'HTI': 'Haiti', 'HND': 'Honduras', 'HUN': 'Hungary', 'ISL': 'Iceland',
                    'IND': 'India', 'IDN': 'Indonesia', 'IRN': 'Iran, Islamic Rep.', 'IRQ': 'Iraq',
                    'IRL': 'Ireland', 'ISR': 'Israel', 'ITA': 'Italy', 'JAM': 'Jamaica',
                    'JPN': 'Japan', 'JOR': 'Jordan', 'KAZ': 'Kazakhstan', 'KEN': 'Kenya',
                    'KIR': 'Kiribati', 'PRK': 'Korea, Dem. People\'s Rep.', 'KOR': 'Korea, Rep.', 'KWT': 'Kuwait',
                    'KGZ': 'Kyrgyz Republic', 'LAO': 'Lao PDR', 'LVA': 'Latvia', 'LBN': 'Lebanon',
                    'LSO': 'Lesotho', 'LBR': 'Liberia', 'LBY': 'Libya', 'LTU': 'Lithuania',
                    'LUX': 'Luxembourg', 'MKD': 'North Macedonia', 'MDG': 'Madagascar', 'MWI': 'Malawi',
                    'MYS': 'Malaysia', 'MDV': 'Maldives', 'MLI': 'Mali', 'MLT': 'Malta',
                    'MHL': 'Marshall Islands', 'MRT': 'Mauritania', 'MUS': 'Mauritius', 'MEX': 'Mexico',
                    'FSM': 'Micronesia, Fed. Sts.', 'MDA': 'Moldova', 'MNG': 'Mongolia', 'MNE': 'Montenegro',
                    'MAR': 'Morocco', 'MOZ': 'Mozambique', 'MMR': 'Myanmar', 'NAM': 'Namibia',
                    'NRU': 'Nauru', 'NPL': 'Nepal', 'NLD': 'Netherlands', 'NZL': 'New Zealand',
                    'NIC': 'Nicaragua', 'NER': 'Niger', 'NGA': 'Nigeria', 'NOR': 'Norway',
                    'OMN': 'Oman', 'PAK': 'Pakistan', 'PLW': 'Palau', 'PAN': 'Panama',
                    'PNG': 'Papua New Guinea', 'PRY': 'Paraguay', 'PER': 'Peru', 'PHL': 'Philippines',
                    'POL': 'Poland', 'PRT': 'Portugal', 'QAT': 'Qatar', 'ROU': 'Romania',
                    'RUS': 'Russian Federation', 'RWA': 'Rwanda', 'WSM': 'Samoa', 'STP': 'Sao Tome and Principe',
                    'SAU': 'Saudi Arabia', 'SEN': 'Senegal', 'SRB': 'Serbia', 'SYC': 'Seychelles',
                    'SLE': 'Sierra Leone', 'SGP': 'Singapore', 'SVK': 'Slovak Republic', 'SVN': 'Slovenia',
                    'SLB': 'Solomon Islands', 'SOM': 'Somalia', 'ZAF': 'South Africa', 'SSD': 'South Sudan',
                    'ESP': 'Spain', 'LKA': 'Sri Lanka', 'SDN': 'Sudan', 'SUR': 'Suriname',
                    'SWZ': 'Eswatini', 'SWE': 'Sweden', 'CHE': 'Switzerland', 'SYR': 'Syrian Arab Republic',
                    'TJK': 'Tajikistan', 'TZA': 'Tanzania', 'THA': 'Thailand', 'TLS': 'Timor-Leste',
                    'TGO': 'Togo', 'TON': 'Tonga', 'TTO': 'Trinidad and Tobago', 'TUN': 'Tunisia',
                    'TUR': 'Turkey', 'TKM': 'Turkmenistan', 'TUV': 'Tuvalu', 'UGA': 'Uganda',
                    'UKR': 'Ukraine', 'ARE': 'United Arab Emirates', 'GBR': 'United Kingdom', 'USA': 'United States',
                    'URY': 'Uruguay', 'UZB': 'Uzbekistan', 'VUT': 'Vanuatu', 'VEN': 'Venezuela, RB',
                    'VNM': 'Vietnam', 'YEM': 'Yemen, Rep.', 'ZMB': 'Zambia', 'ZWE': 'Zimbabwe'
                };
            }

            async loadAllCountries() {
                try {
                    const response = await fetch('https://api.worldbank.org/v2/country?format=json&per_page=300');
                    const data = await response.json();
                    
                    if (Array.isArray(data) && data.length > 1) {
                        this.allCountries = data[1]
                            .filter(country => country.capitalCity && this.countryCoordinates[country.id])
                            .map(country => ({
                                code: country.id,
                                name: country.name,
                                region: country.region?.value || 'Unknown'
                            }))
                            .sort((a, b) => a.name.localeCompare(b.name));
                        
                        this.updateCountryDropdown();
                    }
                } catch (error) {
                    console.log('Could not load country list from API, using static data');
                    // Fallback to static data
                    this.allCountries = Object.keys(this.countryNames).map(code => ({
                        code: code,
                        name: this.countryNames[code],
                        region: 'Unknown'
                    })).sort((a, b) => a.name.localeCompare(b.name));
                    this.updateCountryDropdown();
                }
            }

            updateCountryDropdown() {
                const countrySelect = document.getElementById('countrySelect');
                const regionSelect = document.getElementById('regionSelect');
                const selectedRegion = regionSelect.value;
                
                // Clear existing options except the first one
                countrySelect.innerHTML = '<option value="">üåê All Countries in Region</option>';
                
                let filteredCountries = this.allCountries;
                if (selectedRegion !== 'all') {
                    // Filter by region - this would need region mapping in a real implementation
                    // For now, show all countries
                    filteredCountries = this.allCountries;
                }
                
                filteredCountries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.code;
                    option.textContent = `${this.getCountryFlag(country.code)} ${country.name}`;
                    countrySelect.appendChild(option);
                });
            }

            getCountryFlag(countryCode) {
                // Simple flag emoji mapping for visual appeal
                const flags = {
                    'USA': 'üá∫üá∏', 'CHN': 'üá®üá≥', 'JPN': 'üáØüáµ', 'DEU': 'üá©üá™', 'IND': 'üáÆüá≥',
                    'GBR': 'üá¨üáß', 'FRA': 'üá´üá∑', 'ITA': 'üáÆüáπ', 'BRA': 'üáßüá∑', 'CAN': 'üá®üá¶',
                    'KOR': 'üá∞üá∑', 'RUS': 'üá∑üá∫', 'ESP': 'üá™üá∏', 'AUS': 'üá¶üá∫', 'MEX': 'üá≤üáΩ',
                    'IDN': 'üáÆüá©', 'NLD': 'üá≥üá±', 'SAU': 'üá∏üá¶', 'TUR': 'üáπüá∑', 'TWN': 'üáπüáº'
                };
                return flags[countryCode] || 'üè≥Ô∏è';
            }

            async loadAndVisualizeData() {
                const indicator = document.getElementById('indicatorSelect').value;
                const year = document.getElementById('yearSelect').value;
                const region = document.getElementById('regionSelect').value;
                
                this.showLoading(true);
                this.clearMessages();
                
                try {
                    const data = await this.fetchWorldBankData(indicator, year, region);
                    if (data && data.length > 0) {
                        this.currentData = data;
                        this.updateVisualization();
                        this.showStatistics(data, indicator);
                        this.showMessage('‚úÖ Data loaded successfully!', 'info');
                    } else {
                        this.showMessage('‚ö†Ô∏è No data available for the selected criteria.', 'warning');
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showMessage('‚ùå Error loading data. Please try again.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            async fetchWorldBankData(indicator, year, region = 'all') {
                const countrySelect = document.getElementById('countrySelect');
                const selectedCountry = countrySelect.value;
                
                // If specific country selected, use that
                if (selectedCountry) {
                    const apiUrl = `https://api.worldbank.org/v2/country/${selectedCountry}/indicator/${indicator}?date=${year}&format=json&per_page=50`;
                    console.log('Fetching data from:', apiUrl);
                    return this.fetchDataFromAPI(apiUrl, indicator);
                }
                
                // For regions, we need to get individual countries, not regional aggregates
                let countryQuery;
                if (region === 'all') {
                    countryQuery = 'all';
                } else {
                    // Map region codes to country lists for individual country data
                    const regionCountries = this.getCountriesInRegion(region);
                    if (regionCountries.length > 0) {
                        countryQuery = regionCountries.join(';');
                    } else {
                        countryQuery = 'all'; // Fallback to all countries
                    }
                }
                
                const apiUrl = `https://api.worldbank.org/v2/country/${countryQuery}/indicator/${indicator}?date=${year}&format=json&per_page=300`;
                console.log('Fetching data from:', apiUrl);
                return this.fetchDataFromAPI(apiUrl, indicator);
            }

            getCountriesInRegion(region) {
                // Map World Bank region codes to actual country codes
                const regionMap = {
                    'SAS': ['AFG', 'BGD', 'BTN', 'IND', 'MDV', 'NPL', 'PAK', 'LKA'], // South Asia
                    'EAS': ['CHN', 'JPN', 'KOR', 'MNG', 'PRK'], // East Asia & Pacific (sample)
                    'ECS': ['ALB', 'ARM', 'AZE', 'BLR', 'BIH', 'BGR', 'HRV', 'CZE', 'EST', 'GEO', 'HUN', 'KAZ', 'KGZ', 'LVA', 'LTU', 'MDA', 'MNE', 'POL', 'ROU', 'RUS', 'SRB', 'SVK', 'SVN', 'TJK', 'TKM', 'UKR', 'UZB'], // Europe & Central Asia
                    'LCN': ['ARG', 'BLZ', 'BOL', 'BRA', 'CHL', 'COL', 'CRI', 'CUB', 'DOM', 'ECU', 'SLV', 'GTM', 'GUY', 'HTI', 'HND', 'JAM', 'MEX', 'NIC', 'PAN', 'PRY', 'PER', 'SUR', 'TTO', 'URY', 'VEN'], // Latin America & Caribbean
                    'MEA': ['DZA', 'BHR', 'EGY', 'IRN', 'IRQ', 'ISR', 'JOR', 'KWT', 'LBN', 'LBY', 'MAR', 'OMN', 'QAT', 'SAU', 'SYR', 'TUN', 'ARE', 'YEM'], // Middle East & North Africa
                    'NAC': ['CAN', 'USA'], // North America
                    'AFR': ['AGO', 'BEN', 'BWA', 'BFA', 'BDI', 'CMR', 'CPV', 'CAF', 'TCD', 'COM', 'COG', 'COD', 'CIV', 'DJI', 'GNQ', 'ERI', 'ETH', 'GAB', 'GMB', 'GHA', 'GIN', 'GNB', 'KEN', 'LSO', 'LBR', 'MDG', 'MWI', 'MLI', 'MRT', 'MUS', 'MOZ', 'NAM', 'NER', 'NGA', 'RWA', 'STP', 'SEN', 'SYC', 'SLE', 'SOM', 'ZAF', 'SSD', 'SDN', 'SWZ', 'TZA', 'TGO', 'UGA', 'ZMB', 'ZWE'] // Sub-Saharan Africa
                };
                
                return regionMap[region] || [];
            }

            async fetchDataFromAPI(apiUrl, indicator) {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const jsonData = await response.json();
                
                // World Bank API returns an array where first element is metadata, second is data
                if (!Array.isArray(jsonData) || jsonData.length < 2) {
                    throw new Error('Invalid response format from World Bank API');
                }
                
                const data = jsonData[1];
                
                if (!Array.isArray(data)) {
                    throw new Error('No data returned from API');
                }
                
                console.log(`üìä Raw data items: ${data.length}`);
                
                // Filter out null values and format data
                const processedData = data
                    .filter(item => {
                        // Filter out regional aggregates and null values
                        if (!item || item.value === null || item.value === undefined) return false;
                        
                        const countryCode = item.countryiso3code || item.country?.id;
                        
                        // Skip regional aggregates (they usually have longer codes or specific patterns)
                        if (!countryCode || countryCode.length !== 3) return false;
                        
                        // Only include countries we have coordinates for
                        return this.countryCoordinates[countryCode];
                    })
                    .map(item => ({
                        countryCode: item.countryiso3code || item.country?.id,
                        countryName: item.country?.value || item.country?.name || 'Unknown',
                        value: parseFloat(item.value),
                        year: item.date,
                        indicator: item.indicator?.value || indicator
                    }));
                
                console.log(`‚úÖ Processed data items: ${processedData.length}`);
                
                return processedData;
            }

            updateVisualization() {
                if (!this.currentData || this.currentData.length === 0) return;
                
                // Clear existing layer
                if (this.currentLayer) {
                    this.map.removeLayer(this.currentLayer);
                }
                
                // Remove existing legend
                if (this.legend) {
                    this.map.removeControl(this.legend);
                }
                
                const colorScheme = document.getElementById('colorScheme').value;
                const classificationMethod = document.getElementById('classificationMethod').value;
                
                // Calculate breaks
                const values = this.currentData.map(d => d.value);
                const breaks = this.calculateBreaks(values, classificationMethod, 7);
                const colors = this.colorSchemes[colorScheme];
                
                // Create markers
                this.currentLayer = L.layerGroup();
                
                this.currentData.forEach(item => {
                    const coords = this.countryCoordinates[item.countryCode];
                    if (coords) {
                        const colorIndex = this.getColorIndex(item.value, breaks);
                        const color = colors[colorIndex];
                        
                        // Enhanced marker sizing with user preference
                        const markerSize = document.getElementById('markerSize').value;
                        const sizeRange = this.markerSizes[markerSize];
                        const maxValue = Math.max(...values);
                        const minValue = Math.min(...values);
                        const normalizedValue = (item.value - minValue) / (maxValue - minValue);
                        const radius = sizeRange.min + (normalizedValue * (sizeRange.max - sizeRange.min));
                        
                        const marker = L.circleMarker(coords, {
                            radius: radius,
                            fillColor: color,
                            color: this.showLabels ? '#000' : '#fff',
                            weight: this.showLabels ? 3 : 2,
                            opacity: 1,
                            fillOpacity: 0.85,
                            className: 'enhanced-marker'
                        });
                        
                        // Enhanced popup with more information
                        const flag = this.getCountryFlag(item.countryCode);
                        marker.bindPopup(`
                            <div class="popup-content">
                                <h6><strong>${flag} ${item.countryName}</strong></h6>
                                <hr style="margin: 5px 0;">
                                <p><strong>üìä ${item.indicator}</strong></p>
                                <p><strong>üìÖ Year:</strong> ${item.year}</p>
                                <p><strong>üìà Value:</strong> <span style="color: ${color}; font-weight: bold;">${this.formatValue(item.value)}</span></p>
                                <p style="font-size: 0.8em; color: #666; margin-top: 10px;">
                                    <strong>Country Code:</strong> ${item.countryCode}<br>
                                    <strong>Coordinates:</strong> ${coords[0].toFixed(2)}, ${coords[1].toFixed(2)}
                                </p>
                            </div>
                        `);
                        
                        this.currentLayer.addLayer(marker);
                        
                        // Add label if enabled
                        if (this.showLabels) {
                            const labelIcon = L.divIcon({
                                className: 'country-label',
                                html: `<div style="background: rgba(255,255,255,0.9); padding: 2px 4px; border-radius: 3px; font-size: 10px; font-weight: bold; border: 1px solid #000;">${item.countryCode}</div>`,
                                iconSize: [30, 15],
                                iconAnchor: [15, -radius - 5]
                            });
                            
                            const labelMarker = L.marker(coords, { icon: labelIcon });
                            this.currentLayer.addLayer(labelMarker);
                        }
                    }
                });
                
                this.currentLayer.addTo(this.map);
                
                // Auto-fit to data if specific country is selected or data is limited
                const selectedCountry = document.getElementById('countrySelect').value;
                if (selectedCountry || this.currentData.length <= 10) {
                    this.fitMapToData();
                } else if (this.currentLayer.getLayers().length > 0) {
                    // For larger datasets, fit with padding
                    this.map.fitBounds(this.currentLayer.getBounds(), { padding: [20, 20] });
                }
                
                // Add legend
                this.addLegend(breaks, colors);
            }

            calculateBreaks(values, method, numClasses) {
                const sortedValues = [...values].sort((a, b) => a - b);
                const n = sortedValues.length;
                
                switch (method) {
                    case 'quantile':
                        const breaks = [];
                        for (let i = 0; i <= numClasses; i++) {
                            const index = Math.floor((i * (n - 1)) / numClasses);
                            breaks.push(sortedValues[index]);
                        }
                        return breaks;
                        
                    case 'equal':
                        const min = sortedValues[0];
                        const max = sortedValues[n - 1];
                        const interval = (max - min) / numClasses;
                        return Array.from({ length: numClasses + 1 }, (_, i) => min + (i * interval));
                        
                    case 'natural':
                        // Simplified natural breaks (Jenks-like)
                        return this.jenksBreaks(sortedValues, numClasses);
                        
                    default:
                        return this.calculateBreaks(values, 'quantile', numClasses);
                }
            }

            jenksBreaks(values, numClasses) {
                // Simplified Jenks natural breaks algorithm
                const n = values.length;
                if (n <= numClasses) {
                    return values;
                }
                
                // For simplicity, use quantile breaks as approximation
                return this.calculateBreaks(values, 'quantile', numClasses);
            }

            getColorIndex(value, breaks) {
                for (let i = 0; i < breaks.length - 1; i++) {
                    if (value <= breaks[i + 1]) {
                        return i;
                    }
                }
                return breaks.length - 2; // Last color
            }

            addLegend(breaks, colors) {
                this.legend = L.control({ position: 'bottomright' });
                
                this.legend.onAdd = () => {
                    const div = L.DomUtil.create('div', 'legend');
                    div.innerHTML = '<div class="legend-title">Legend</div>';
                    
                    for (let i = 0; i < breaks.length - 1; i++) {
                        const min = this.formatValue(breaks[i]);
                        const max = this.formatValue(breaks[i + 1]);
                        div.innerHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${colors[i]}"></div>
                                <span>${min} - ${max}</span>
                            </div>
                        `;
                    }
                    
                    return div;
                };
                
                this.legend.addTo(this.map);
            }

            showStatistics(data, indicator) {
                const values = data.map(d => d.value);
                const stats = {
                    count: values.length,
                    min: Math.min(...values),
                    max: Math.max(...values),
                    mean: values.reduce((a, b) => a + b, 0) / values.length,
                    median: this.median(values)
                };
                
                const statsHtml = `
                    <div class="col-md-2">
                        <div class="metric-card">
                            <div class="metric-value">${stats.count}</div>
                            <div class="metric-label">Countries</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-card">
                            <div class="metric-value">${this.formatValue(stats.min)}</div>
                            <div class="metric-label">Minimum</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="metric-card">
                            <div class="metric-value">${this.formatValue(stats.max)}</div>
                            <div class="metric-label">Maximum</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${this.formatValue(stats.mean)}</div>
                            <div class="metric-label">Average</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value">${this.formatValue(stats.median)}</div>
                            <div class="metric-label">Median</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('statsContent').innerHTML = statsHtml;
                document.getElementById('statsPanel').style.display = 'block';
            }

            median(values) {
                const sorted = [...values].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            }

            formatValue(value) {
                if (typeof value !== 'number') return 'N/A';
                
                if (value >= 1e12) return (value / 1e12).toFixed(2) + 'T';
                if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
                if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
                if (value >= 1e3) return (value / 1e3).toFixed(2) + 'K';
                
                return value.toFixed(2);
            }

            showLoading(show) {
                document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            }

            showMessage(message, type) {
                const container = document.getElementById('messageContainer');
                const className = type === 'error' ? 'error-message' : 
                                 type === 'warning' ? 'alert alert-warning' : 'info-message';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = className;
                messageDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
                `;
                
                container.appendChild(messageDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        messageDiv.remove();
                    }
                }, 5000);
            }

            clearMessages() {
                document.getElementById('messageContainer').innerHTML = '';
            }

            fitMapToData() {
                if (!this.currentLayer || !this.currentData) return;
                
                const bounds = [];
                this.currentData.forEach(item => {
                    const coords = this.countryCoordinates[item.countryCode];
                    if (coords && item.value !== null) {
                        bounds.push(coords);
                    }
                });
                
                if (bounds.length > 0) {
                    if (bounds.length === 1) {
                        // Single country - zoom to it
                        this.map.setView(bounds[0], 6);
                    } else {
                        // Multiple countries - fit bounds
                        const group = new L.featureGroup(bounds.map(coord => L.marker(coord)));
                        this.map.fitBounds(group.getBounds().pad(0.1));
                    }
                }
            }

            exportData() {
                if (!this.currentData) {
                    alert('No data to export. Please load data first.');
                    return;
                }
                
                const indicator = document.getElementById('indicatorSelect').selectedOptions[0].text;
                const year = document.getElementById('yearSelect').value;
                const region = document.getElementById('regionSelect').selectedOptions[0].text;
                
                const exportData = this.currentData.map(item => ({
                    'Country Code': item.countryCode,
                    'Country Name': item.countryName,
                    'Indicator': indicator,
                    'Year': year,
                    'Value': item.value,
                    'Region': region
                }));
                
                const csvContent = this.convertToCSV(exportData);
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `world_bank_data_${year}_${indicator.replace(/[^a-zA-Z0-9]/g, '_')}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                this.showNotification('‚úÖ Data exported successfully!', 'success');
            }
            
            convertToCSV(data) {
                const headers = Object.keys(data[0]);
                const csvRows = [headers.join(',')];
                
                data.forEach(row => {
                    const values = headers.map(header => {
                        const value = row[header];
                        return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                    });
                    csvRows.push(values.join(','));
                });
                
                return csvRows.join('\n');
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type === 'success' ? 'success' : 'info'} notification`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    min-width: 300px;
                    animation: slideIn 0.3s ease-out;
                `;
                notification.innerHTML = `
                    <button type="button" class="btn-close" style="float: right;" onclick="this.parentElement.remove()"></button>
                    ${message}
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new WorldBankVisualizer();
        });
    </script>
</body>
</html> 